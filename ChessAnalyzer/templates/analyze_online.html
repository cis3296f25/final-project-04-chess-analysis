{% extends "base.html" %}
{% block title %}Analyze Online Games{% endblock %}
{% block content %}
<div class="container mt-4">
    <h1>Analyze Online Games</h1>
    <p>This section will allow you to fetch and analyze games from Chess.com and Lichess.</p>
    <form method="post">
        {% csrf_token %}
        <div class="form-group">
            <label for="username">Username:</label>
            <input type="text" id="username" name="username" class="form-control" placeholder="Enter Chess.com or Lichess username" required>
        </div>
        <div class="form-group">
            <label for="platform">Platform:</label>
            <select id="platform" name="platform" class="form-control">
                <option>Chess.com</option>
                <option>Lichess</option>
            </select>
        </div>
        <button type="submit" name="action" value="lookup" class="btn btn-primary">Lookup ELO</button>
        <div class="form-group">
            <label for="count">Number of recent games:</label>
            <input type="number" id="count" name="count" class="form-control"
                   value="10" min="1" max="100">
        </div>
        <button type="submit" name="action" value="load_games" class="btn btn-success mt-3">Load Games</button>
        <div class="spinner-border text-primary" role="status" id="loading-spinner" style="display: none; width: 1.5rem; height: 1.5rem;">
            <span class="sr-only">Loading...</span>
        </div>
    </form>

    {% if stats %}
    <div class="mt-3">
        <h3>{{ platform }} Ratings for {{ username }}</h3>
        <ul>
            <li>Rapid: {{ stats.rapid }}</li>
            <li>Blitz: {{ stats.blitz }}</li>
            <li>Bullet: {{ stats.bullet }}</li>
        </ul>
    </div>
    {% endif %}

    {% if game_list %}
    <hr>
    <h2>Games:</h2>

    <div class="mb-3">
        {% for g in game_list %}
            {% if g == current_game %}
                <a href="?game={{ g }}" class="btn btn-primary btn-sm">{{ g }}</a>
            {% else %}
                <a href="?game={{ g }}" class="btn btn-outline-primary btn-sm">{{ g }}</a>
            {% endif %}
        {% endfor %}
    </div>

    <h3>Analysis for Game {{ current_game }}</h3>

    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>#</th>
                <th>Move</th>
                <th>Eval</th>
            </tr>
        </thead>
        <tbody>
        {% for entry in page_obj %}
            <tr>
                <td>{{ forloop.counter0|add:page_obj.start_index }}</td>
                <td>{{ entry.move }}</td>
                <td>{{ entry.evaluation }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

        <nav aria-label="Move navigation">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?game={{ current_game }}&page=1">&laquo; First</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?game={{ current_game }}&page={{ page_obj.previous_page_number }}">Previous</a>
                    </li>
                {% endif %}

                <li class="page-item disabled">
                    <span class="page-link">
                        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                    </span>
                </li>

                {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link"
                           href="?game={{ current_game }}&page={{ page_obj.next_page_number }}">Next</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?game={{ current_game }}&page={{ page_obj.paginator.num_pages }}">Last
                            &raquo;</a>
                    </li>
                {% endif %}
            </ul>
        </nav>

    <div class="mt-3">
        <a href="{% url 'advantage_graph' %}?game={{ current_game }}" 
        class="btn btn-success">
        View Advantage Graph
        </a>
    </div>
    {% endif %}

    {% if error %}
    <div class="alert alert-danger mt-3">
        {{ error }}
    </div>
{% endif %}
</div>
{% endblock %}
